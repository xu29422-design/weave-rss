# 轻维表推送配置指南

## 概述

本指南说明如何配置 Weave 系统，使其在推送到机器人的同时，也将数据推送到金山文档轻维表中。

## 前置条件

1. **金山文档开放平台账号**
   - 访问 [金山文档开放平台](https://developer.kdocs.cn/)
   - 注册并创建应用
   - 获取 App ID 和 App Secret

2. **轻维表文档**
   - 在金山文档中创建一个轻维表
   - 获取轻维表的 file_token（从文档 URL 中提取）
   - 获取数据表（DBSheet）的 ID

## 配置步骤

### 步骤 1：创建轻维表并设计字段结构

1. 在金山文档中创建轻维表
2. 设计表结构，建议包含以下字段：
   - **日期**（文本或日期类型）
   - **今日焦点**（文本类型，长文本）
   - **分类数量**（数字类型）
   - **文章总数**（数字类型）
   - **简报内容**（文本类型，长文本）
   - **分类1、分类2...**（文本类型，可选，用于存储各分类内容）

### 步骤 2：获取轻维表信息

1. **获取 file_token**：
   - 打开轻维表文档
   - 从 URL 中提取 file_token
   - 例如：`https://kdocs.cn/l/xxx` 中的 `xxx` 就是 file_token

2. **获取 DBSheet ID**：
   - 通过 API 获取 Schema 信息
   - 或从轻维表设置中查看数据表 ID

### 步骤 3：在 Weave 中配置

1. 登录 Weave 系统
2. 进入配置页面
3. 找到"轻维表推送"配置区域
4. 填写以下信息：
   - **App ID**：从金山文档开放平台获取
   - **App Secret**：从金山文档开放平台获取
   - **轻维表 File Token**：从步骤 2 获取
   - **数据表 ID**：从步骤 2 获取
   - **启用轻维表推送**：勾选此选项

### 步骤 4：测试配置

1. 保存配置
2. 手动触发一次简报生成
3. 检查轻维表中是否成功创建了新记录
4. 检查推送日志，确认推送状态

## API 认证说明

根据金山文档开放平台的认证方式，可能需要：

1. **OAuth 2.0 授权**：
   - 用户授权后获取 access_token
   - 使用 access_token 调用 API

2. **应用凭证认证**：
   - 使用 App ID 和 App Secret
   - 通过 client_credentials 方式获取 token

**注意**：当前实现使用的是 client_credentials 方式，如果金山文档 API 要求 OAuth 授权，需要修改认证逻辑。

## 数据格式

推送到轻维表的数据格式：

```json
{
  "日期": "2026-01-30",
  "今日焦点": "今日焦点内容...",
  "分类数量": 3,
  "文章总数": 20,
  "简报内容": "完整的简报 Markdown 内容...",
  "分类1": "分类名称: 分类内容...",
  "分类2": "分类名称: 分类内容..."
}
```

## 故障排查

### 问题 1：认证失败
- 检查 App ID 和 App Secret 是否正确
- 确认应用在开放平台中已激活
- 检查 API 调用频率是否超限

### 问题 2：找不到数据表
- 确认 file_token 是否正确
- 确认 DBSheet ID 是否存在
- 尝试通过 API 获取 Schema 信息验证

### 问题 3：字段不匹配
- 检查轻维表中的字段名称是否与代码中的字段名称一致
- 确认字段类型是否匹配（文本、数字等）

### 问题 4：推送成功但数据为空
- 检查字段映射是否正确
- 确认数据内容是否超过字段长度限制
- 查看日志了解详细错误信息

## 注意事项

1. **字段名称**：轻维表中的字段名称必须与代码中使用的字段名称完全一致（区分大小写）

2. **数据长度**：某些字段可能有长度限制，代码中已对简报内容进行了截断处理（最多 10000 字符）

3. **API 限制**：注意金山文档 API 的调用频率限制，避免频繁调用导致失败

4. **错误处理**：即使轻维表推送失败，机器人推送仍会继续执行，不会影响整体流程

5. **数据安全**：App Secret 等敏感信息请妥善保管，不要泄露

## 相关链接

- [金山文档开放平台](https://developer.kdocs.cn/)
- [轻维表 API 文档](https://developer.kdocs.cn/server/light-table/)
- [API 认证文档](https://developer.kdocs.cn/server/guide/api-overview.html)
