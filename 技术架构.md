Tech Spec: Serverless AI RSS Digest System
1. System Overview
构建一个基于 Vercel 的自动化情报系统。 核心逻辑：周一至周五定时触发 -> 抓取 RSS -> Map (并发 AI 清洗/评分) -> Reduce (按分类并发 AI 撰写长文) -> 最终合成 Markdown -> 推送 Webhook。

2. Tech Stack
Framework: Next.js 14+ (App Router, TypeScript)

Orchestration: Inngest (必须使用，用于处理 Serverless 超时和并发编排)

Database: Vercel KV (Redis) - 用于 URL 去重 (Deduplication)

AI Engine: Vercel AI SDK (ai core) + Google AI SDK (Gemini)

Model A (Analyst): gemini-1.5-flash (Free, fast, JSON output)

Model B (Writer): gemini-1.5-flash (Free, large context, long-form text)

Utilities: rss-parser, zod (Validation), date-fns

3. Data Models (TypeScript Interfaces)
Cursor 请严格遵循以下类型定义：

TypeScript

// 原始 RSS 条目
interface RawRSSItem {
  title: string;
  link: string;
  contentSnippet?: string; // 摘要或正文前200字
  pubDate: string;
  sourceName: string;
}

// AI 分析结果 (Map 阶段输出)
// 使用 Zod schema: z.object({...})
interface AnalyzedItem {
  title: string;
  link: string;
  summary: string; // 简短摘要
  category: 'AI Tech' | 'Product' | 'Market' | 'Coding' | 'Other'; // 可配置
  score: number; // 1-10, <6 丢弃
  reasoning: string; // 评分理由
}

// 最终章节 (Reduce 阶段输出)
interface ReportSection {
  category: string;
  markdownContent: string; // 该分类下的深度长文 (约 1000-2000 字)
  referenceLinks: string[]; // 引用源列表
}
4. Workflow Orchestration (Inngest)
创建一个 Inngest Function daily-digest-workflow，包含以下 Steps：

Trigger
Cron: 0 1 * * 1-5 (UTC 1:00 AM = Beijing 9:00 AM, Weekdays only)

Step 1: Ingest & Dedupe
读取配置的 RSS URL 列表。

并行抓取 (Promise.all) 并解析 XML。

生成 item.link 的 Hash。

查询 Redis (digest:seen:${hash})。

Filter: 仅保留 Redis 中不存在 且 pubDate 在 24小时内的 Items。

Write: 将新 Hash 写入 Redis (TTL: 7 days)。

Return: newItems 数组。

Step 2: Analyst Agent (Map Phase)
Input: newItems

Action: 使用 step.run 并发处理（注意：为了避免 Rate Limit，建议使用 batch processing，每批 10 个）。

AI Task: 调用 gemini-1.5-flash，使用 generateObject 强制输出符合 AnalyzedItem 结构的 JSON。

Filter: 过滤掉 score < 6 的低价值条目。

Step 3: Section Writer (Reduce Phase)
Input: Step 2 筛选后的 High-Quality Items。

Action: 按 category 分组。

AI Task: 对每个非空 Category，并行调用 gemini-1.5-flash。

Prompt: "作为资深科技编辑，根据提供的 {count} 条摘要，撰写一篇深度综述。要求逻辑连贯、引用具体案例，避免罗列。字数要求：1000字以上。"

Step 4: Assembly & Delivery
Action:

生成全局 TL;DR (Executive Summary)。

拼接 Markdown: Title -> TL;DR -> TOC -> Sections -> Footer (Links)。

POST 请求发送到环境变量 WEBHOOK_URL。

5. Implementation Directives (For Cursor)
AI SDK Usage: 使用 vercel/ai 的 generateObject 处理 Step 2，使用 generateText 处理 Step 3。

Error Handling:

RSS Fetch 失败应 catch 并忽略，不应阻断整个流程。

Inngest 步骤需配置 { retries: 3 } 以应对 OpenAI 偶发的 500/429 错误。

Environment Variables:
- GOOGLE_GENERATIVE_AI_API_KEY (可选，也可在配置页设置)
- KV_REST_API_URL / KV_REST_API_TOKEN
- INNGEST_EVENT_KEY / INNGEST_SIGNING_KEY
- ADMIN_PASSWORD (用于配置页登录)

6. Project Structure
Plaintext

app/
  api/inngest/route.ts  # Inngest Serve Handler
inngest/
  client.ts             # Inngest Client Config
  functions/
    daily-digest.ts     # 主要工作流逻辑 (Core Logic)
lib/
  ai-prompts.ts         # System Prompts 定义
  rss-utils.ts          # Fetch & Parse 逻辑
  redis.ts              # KV Client