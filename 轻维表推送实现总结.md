# 轻维表推送功能实现总结

## ✅ 已完成的实现

### 1. 数据模型扩展
- **文件**: `lib/redis.ts`
- **修改**: 在 `Settings` 接口中添加了轻维表相关配置字段
  - `kdocsAppId`: 金山文档 App ID
  - `kdocsAppSecret`: 金山文档 App Secret
  - `kdocsFileToken`: 轻维表文件 token
  - `kdocsDBSheetId`: 数据表 ID
  - `enableKdocsPush`: 是否启用轻维表推送

### 2. API 客户端实现
- **文件**: `lib/kdocs-api.ts` (新建)
- **功能**:
  - `getAccessToken()`: 获取访问令牌
  - `createKdocsRecord()`: 创建单条记录
  - `createKdocsRecords()`: 批量创建记录
  - `pushDigestToKdocs()`: 推送简报数据到轻维表（封装函数）

### 3. 推送逻辑集成
- **文件**: `inngest/functions/daily-digest.ts`
- **修改**:
  - 导入轻维表 API 客户端
  - 在 `assemble-and-send` 步骤中添加轻维表推送逻辑
  - 支持双渠道推送（机器人 + 轻维表）
  - 独立的错误处理，轻维表推送失败不影响机器人推送
  - 更新推送日志，记录两个渠道的推送状态

### 4. 配置页面 UI
- **文件**: `app/config/page.tsx`
- **修改**:
  - 扩展 `ConfigModule` 类型，添加 `'kdocs'`
  - 在 `formState` 中添加轻维表配置字段
  - 在初始化时加载轻维表配置
  - 添加新的配置模块卡片（ModuleCard）
  - 添加帮助内容（HELP_CONTENT）
  - 支持复选框控制启用/禁用
  - 添加配置提示和说明

### 5. 配置指南文档
- **文件**: `轻维表推送配置指南.md` (新建)
- **内容**: 详细的配置步骤、故障排查、注意事项

## 📋 实现的功能特性

### 双渠道推送
- ✅ 推送到机器人（Webhook）- 原有功能
- ✅ 推送到轻维表 - 新增功能
- ✅ 两个渠道独立运行，互不影响

### 数据格式化
- 自动将简报数据格式化为轻维表记录格式
- 包含字段：日期、今日焦点、分类数量、文章总数、简报内容、各分类内容

### 错误处理
- 轻维表推送失败不影响机器人推送
- 详细的错误日志记录
- 推送日志中记录两个渠道的状态

### 用户配置
- 可选的轻维表推送功能（通过开关控制）
- 完整的配置界面
- 配置验证和保存

## 🔧 需要验证和调整的部分

### 1. API 认证方式
当前实现使用的是 `client_credentials` 方式获取 token，但根据金山文档 API 的实际要求，可能需要：
- OAuth 2.0 授权流程
- 用户授权后获取 access_token
- 或者使用其他认证方式

**建议**: 根据实际 API 文档调整 `lib/kdocs-api.ts` 中的 `getAccessToken()` 函数

### 2. API 端点
当前使用的 API 端点：
- Token: `https://open.kdocs.cn/api/v1/openapi/oauth/token`
- 创建记录: `https://open.kdocs.cn/api/v1/openapi/light-table/files/{fileToken}/dbsheets/{dbSheetId}/records`

**建议**: 根据实际 API 文档确认端点是否正确

### 3. 字段映射
当前代码中使用的字段名称：
- `日期`
- `今日焦点`
- `分类数量`
- `文章总数`
- `简报内容`
- `分类1`, `分类2`, ...

**建议**: 根据实际轻维表结构调整字段名称，确保与轻维表中的字段名称完全一致

### 4. 数据表 ID 获取
当前需要用户手动输入 DBSheet ID，可以优化为：
- 通过 API 获取 Schema 信息
- 自动列出所有数据表供用户选择

## 🚀 使用流程

1. **在金山文档开放平台注册应用**
   - 获取 App ID 和 App Secret

2. **创建轻维表**
   - 在金山文档中创建轻维表
   - 设计字段结构（日期、今日焦点、分类数量、文章总数、简报内容等）
   - 获取 File Token 和 DBSheet ID

3. **在 Weave 中配置**
   - 进入配置页面
   - 找到"轻维表推送配置"模块
   - 填写 App ID、App Secret、File Token、DBSheet ID
   - 启用轻维表推送

4. **测试配置**
   - 保存配置
   - 手动触发一次简报生成
   - 检查轻维表中是否成功创建记录

## 📝 后续优化建议

1. **自动获取 Schema**
   - 添加"获取 Schema"按钮，自动获取轻维表结构
   - 显示可用字段列表，方便用户确认

2. **字段映射配置**
   - 允许用户自定义字段映射关系
   - 支持字段类型验证

3. **批量推送优化**
   - 如果 API 支持批量创建，使用批量接口提高效率
   - 添加重试机制

4. **推送历史**
   - 在推送日志中显示轻维表推送记录
   - 提供跳转到轻维表的链接

5. **配置验证**
   - 添加配置测试功能
   - 验证 App ID/Secret 是否有效
   - 验证 File Token 和 DBSheet ID 是否存在

## 🔗 相关文件

- `lib/redis.ts` - Settings 接口定义
- `lib/kdocs-api.ts` - 轻维表 API 客户端
- `inngest/functions/daily-digest.ts` - 推送逻辑
- `app/config/page.tsx` - 配置页面 UI
- `轻维表推送配置指南.md` - 配置指南
- `轻维表推送实现总结.md` - 本文档

## ⚠️ 注意事项

1. **API 认证**: 需要根据实际 API 文档调整认证方式
2. **字段名称**: 确保轻维表中的字段名称与代码中的字段名称完全一致
3. **API 限制**: 注意 API 调用频率限制
4. **错误处理**: 轻维表推送失败不会影响机器人推送
5. **数据安全**: App Secret 等敏感信息请妥善保管

---

**最后更新**: 2026-01-30
